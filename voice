#!/usr/bin/env bash
# Voice typing launcher â€” starts IBus engine + streaming STT pipeline

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
IBUS_PID=""

cleanup() {
    if [ -n "$IBUS_PID" ] && kill -0 "$IBUS_PID" 2>/dev/null; then
        kill "$IBUS_PID" 2>/dev/null
        wait "$IBUS_PID" 2>/dev/null
    fi
}
trap cleanup EXIT INT TERM

# Default: streaming with large-v3-turbo on CUDA
DEFAULT_ARGS=""
if [ $# -eq 0 ]; then
    DEFAULT_ARGS="--streaming --model large-v3-turbo --device cuda --refinement"
fi

# Start IBus engine in background
nix-shell "$SCRIPT_DIR/shell.nix" --run "python -u \"$SCRIPT_DIR/ibus_voice_engine.py\"" &
IBUS_PID=$!
sleep 1  # Give IBus engine time to register

# Check session type
if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
    echo "Bind F12 to ./voice-toggle for pause/resume on Wayland"
fi

exec nix-shell "$SCRIPT_DIR/shell.nix" --run "python -u \"$SCRIPT_DIR/enhanced-voice-typing.py\" $DEFAULT_ARGS $*"
